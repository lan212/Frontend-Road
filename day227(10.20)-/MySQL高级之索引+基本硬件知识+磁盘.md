# MySQL高级

#### 简介

| 序号 | 01             | 02          | 03             | 04            |
| ---- | -------------- | ----------- | -------------- | ------------- |
| 1    | 基本硬件知识   | 体系结构    | 应用优化       | MYSQL常用工具 |
| 2    | 索引           | 存储引擎    | 查询缓存优化   | MYSQL日志     |
| 3    | 视图           | 优化SQL步骤 | 内存管理及优化 | MYSQL主从复制 |
| 4    | 存储过程和函数 | 索引使用    | MySQL锁问题    |               |
| 5    | 触发器         | SQL优化     | 常用SQL技巧    |               |

### 基本硬件知识

#### 计算机工作原理

![1634822355375](随堂笔记/1634822355375.png)

##### 中央处理器 （CPU）

是一台计算机的运算核心和控制核心。CPU、内部存储器和输入、输出设备 是电子计算机三大核心部件。其功能主要是解释计算机指令以及处理计算机软件中的数据。

**<font color='orange'>核心组件：</font>**

* **算术逻辑单元（Arithmetic&logical Unit）**

  是CPU的执行单元，是所有中央处理器的核心组成部分，由"And Gate"（[与门](https://baike.baidu.com/item/与门)） 和"Or Gate"（[或门](https://baike.baidu.com/item/或门)）构成的算术逻辑单元，主要功能是进行二位元的算术运算，如加减乘(不包括整数除法)。

* **PC**

  负责存储内存地址，该地址指向下一条即将执行的指令，每解释执行完一条指令，pc寄存器的值就会自动被更新为下一条指令的地址

* **寄存器（Register）**

  <font color='red'>是CPU内部的元件，所以在寄存器之内的数据传送非常快。</font>

  用途：

  * 可将寄存器内的数据执行算术及逻辑运算
  * 存于寄存器内的地址可用来指向内存的某个位置，即寻址。
  * 可以用来读写数据到电脑的周边设备

* **缓存（Cache）**

##### 内存（Memory）

也称内存储器和主存储器，它<font color='red'>用于暂时存放Cpu中的运算数据，与硬盘等外部存储器交换的数据</font>。

<font style="color:#000;background-color:#ff0">是外存与CPU进行沟通的桥梁</font>，计算机中所有程序的运行都在内存中进行，内存性能的强弱影响计算机整体发挥的水平。只要计算机开始运行，操作系统就会把需要运算的数据从内存中调到CPU中进行运算，当运算完成，CPU将结果传送出来。

##### 磁盘（硬盘）

`Mysql`的数据就是存储在硬盘（磁盘）中

### 磁盘概念

**（1）盘片、片面 和 磁头**

硬盘中一般会有多个盘片组成，每个盘片包含两个面，每个盘面都对应地有一个读/写磁头。受到硬盘整体体积和生产成本的限制，盘片数量都受到限制，一般都在5片以内。盘片的编号自下向上从0开始，如最下边的盘片有0面和1面，再上一个盘片就编号为2面和3面。

如下图：

![img](随堂笔记/clipboard.png)

![img](随堂笔记/clipboard1.png)

**（2）扇区 和 磁道**

下图显示的是一个盘面，盘面中一圈圈灰色同心圆为一条条磁道，从圆心向外画直线，可以将磁道划分为若干个弧段，每个磁道上一个弧段被称之为一个扇区（图践绿色部分）。扇区是磁盘的最小组成单元，通常是512字节。（由于不断提高磁盘的大小，部分厂商设定每个扇区的大小是4096字节）

![img](随堂笔记/clipboard2.png)

通过磁头和磁道的接触，然后我们进行数据的读写

**（3）磁头 和 柱面**

硬盘通常由重叠的一组盘片构成，每个盘面都被划分为数目相等的磁道，并从外缘的“0”开始编号，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面。磁盘的柱面数与一个盘面上的磁道数是相等的。由于每个盘面都有自己的磁头，因此，盘面数等于总的磁头数。 如下图

![img](随堂笔记/clipboard3.png)

**3、磁盘容量计算**

存储容量 ＝ 磁头数 × 磁道(柱面)数 × 每道扇区数 × 每扇区字节数图3中磁盘是一个 3个圆盘6个磁头，7个柱面（每个盘片7个磁道） 的磁盘，上图中每条磁道有12个扇区，所以此磁盘的容量为：存储容量 6 * 7 * 12 * 512 = 258048  

每个磁道的扇区数一样是说的老的硬盘，外圈的密度小，内圈的密度大，每圈可存储的数据量是一样的。新的硬盘数据的密度都一致，这样磁道的周长越长，扇区就越多，存储的数据量就越大。

**4、磁盘读取响应时间**

1. <font color='red'>`寻道时间`：</font>磁头从开始移动到数据所在磁道所需要的时间，寻道时间越短，I/O操作越快，目前磁盘的平均寻道时间一般在3－15 ms，一般都在10 ms左右。
2. <font color='red'>`旋转延迟`：</font>盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间，旋转延迟取决于磁盘转速。普通硬盘一般都是7200 rpm，慢的5400 rpm。
3. 数据传输时间：完成传输所请求的数据所需要的时间。

小结一下：从上面的指标来看、其实最重要的、或者说、我们最关心的应该只有两个：寻道时间；旋转延迟

**读写一次磁盘信息所需的时间可分解为：寻道时间、延迟时间、传输时间。为提高磁盘传输效率，<font style="color:#000;background-color:#ff0">软件应着重考虑减少寻道时间和延迟时间</font>。（类似于CPU缓存行，把随机读改成顺序读写）**

**5、块/簇**

磁盘块/簇（虚拟出来的）。 块是操作系统中最小的逻辑存储单位。操作系统与磁盘打交道的最小单位是磁盘块。每个块可以包括2、4、8、16、32、64…2的n次方个扇区。

**为什么存在磁盘块？**

读取方便：<font color='cornflowerblue'>由于扇区的数量比较小，数目众多在寻址时比较困难，所以操作系统就将相邻的扇区组合在一起，形成一个块，再对块进行整体的操作。</font>分离对底层的依赖：操作系统忽略对底层物理存储结构的设计。通过虚拟出来磁盘块的概念，在系统中认为块是最小的单位。（就是类似于班级，小组等）

**6、page**

操作系统经常与内存和硬盘这两种存储设备进行通信，类似于“块”的概念，都需要一种虚拟的基本单位。所以，与内存操作，是虚拟一个页的概念来作为最小单位。与硬盘打交道，就是以块为最小单位。

**7、扇区、块/簇、page的关系**

1. <font color='red'>扇区： 硬盘的最小读写单元</font>
2. <font color='red'>块/簇： 是操作系统针对硬盘读写的最小单元</font>
3. <font color='red'>page： 是内存与操作系统之间操作的最小单元。</font>

扇区 <= 块/簇 <= page

**8、计算机读取数据流程**

当需要从磁盘读取数据时，系统会将数据地址传给磁盘，即确定要读的数据在哪个磁道，哪个扇区。为了读取这个扇区的数据，需要将磁头放到这个扇区上方，为了实现这一点，磁头需要移动对准相应磁道，这个过程叫做 寻道 ，所耗费时间叫做 寻道时间 ，然后磁盘旋转将目标扇区旋转到磁头下，这个过程耗费的时间叫做**旋转时间**。

#### **局部性原理,磁盘预读,CPU缓存行,磁盘IO**

​	1、由于存储介质的特性，磁盘本身存取就比主存慢很多，再加上机械运动耗费，磁盘的存取速度往往是主存的十万分之一，因此为了提高效率，要**尽量减少磁盘I/O**。为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。这样做的理论依据是计算机科学中著名的**局部性原理**：

当一个数据被用到时，其附近的数据也通常会马上被使用。程序运行期间所需要的数据通常比较集中。由于磁盘顺序读取的效率很高（不需要寻道时间，只需很少的旋转时间），因此对于具有局部性的程序来说，预读可以提高I/O效率。

预读的长度一般为**页（page）**的整倍数。页是计算机管理存储器的逻辑块，硬件及操作系统往往将主存和磁盘存储区分割为连续的大小相等的块，每个存储块称为一页（在许多操作系统中，页得大小通常为4k），主存和磁盘以页为单位交换数据。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。

下图是计算机硬件延迟的对比图，供大家参考：

![img](随堂笔记/clipboard4.png)

##### 磁盘IO的问题

`mysql`的数据一般以文件形式存储在磁盘上，检索需要磁盘I/O操作。与主存不同，磁盘I/O存在机械运动耗费，因此磁盘I/O的时间消耗是巨大的。

![img](随堂笔记/clipboard5.png)

###### 注意：

* <font style="color:#000;background-color:#ff0">**数组之所以查询比链表查询快，根本原因是：CPU缓存读取内存，内存读取磁盘时，会把附近一整块数据一起拿过去。所以说物理地址相连的数组，查询速度特别快。**</font>

## 索引

### 概述

索引是帮助MySQL高效获取数据的数据结构（有序）

在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式 指向数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引

* 
* 